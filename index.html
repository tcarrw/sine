<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#0b0d11">
<title>Sine — Calm, Honey & Bridge</title>
<meta name="description" content="Gentle tones for relaxation, focus, and breath pacing. Scenes presets, Moon rhythm, Honey & MirrorHoney, and a bridge to Jar (School & Rooms). Headphones recommended for binaural and MirrorHoney."/>
<style>
  :root{
    color-scheme:dark;
    --bg:#0b0d11; --panel:#11161f; --edge:#1d2430; --ink:#e7edf7; --muted:#a8b3c7; --glow:#66e1ff;
    --green:#a4ff65; --blue:#86c9ff; --violet:#b38bff;
  }
  *{box-sizing:border-box}
  html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:28px 16px 86px}
  header{display:flex;justify-content:space-between;gap:14px;align-items:flex-start;margin-bottom:10px}
  h1{margin:0;font-size:1.5rem;letter-spacing:.2px}
  .tag{color:var(--muted);font-size:.96rem}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.07)),var(--panel);border:1px solid var(--edge);border-radius:16px;padding:16px}
  .titleline{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .titleline h3{margin:0;font-size:1.05rem}
  .huebar{height:6px;border-radius:999px;background:linear-gradient(90deg,#2bc2ff,#a4ff65);opacity:.7}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  label{font-size:.92rem;color:var(--muted);display:inline-flex;gap:8px;align-items:center}
  input[type=range]{width:220px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  button{appearance:none;border:1px solid var(--edge);border-radius:12px;background:#121826;color:var(--ink);padding:9px 12px;cursor:pointer}
  button:hover{border-color:#2b3545;box-shadow:0 0 0 2px rgba(102,225,255,.12)}
  .pill{border:1px solid var(--edge);border-radius:999px;padding:6px 10px;font-size:.86rem;color:var(--muted)}
  .note{font-size:.92rem;color:var(--muted)}
  .meter{height:10px;border-radius:999px;background:#0e1320;border:1px solid var(--edge);overflow:hidden;min-width:180px}
  .meter>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2bc2ff,#a4ff65)}
  .faq details{border:1px solid var(--edge);border-radius:12px;padding:10px;background:rgba(255,255,255,.03)} .faq details+details{margin-top:8px}
  .faq summary{cursor:pointer;font-weight:700}
  .badgelike{display:inline-flex;gap:8px;align-items:center}
  .moon{font-size:1.1rem}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;border:1px solid var(--edge);border-radius:6px;padding:1px 6px;background:#0f1421;color:#dfe7f7}
  :focus-visible{outline:2px solid var(--glow);outline-offset:2px}
  @media (prefers-reduced-motion:reduce){ .pulse{animation:none} }
</style>

<!-- Small FAQ JSON-LD -->
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"FAQPage","mainEntity":[
 {"@type":"Question","name":"How do Scenes work?","acceptedAnswer":{"@type":"Answer","text":"Scenes are gentle presets that set frequency, wave, and suggested breath. Use them as starting points and adjust by feel."}},
 {"@type":"Question","name":"What is MirrorHoney?","acceptedAnswer":{"@type":"Answer","text":"A stereo honey bed with a soft mirror pan / micro-beat. Headphones recommended."}},
 {"@type":"Question","name":"Where do I get help?","acceptedAnswer":{"@type":"Answer","text":"Open the Notes · FAQs on this page, or the Support · FAQs card on Froot. Nothing is uploaded; everything runs locally."}}
]}
</script>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Sine — Calm, Honey &amp; Bridge</h1>
      <div class="tag">Scenes presets · Moon rhythm · Honey &amp; MirrorHoney · Binaural · Calming Sequence. Bridge to <b>Jar</b> (School &amp; Rooms) when you want words and story.</div>
    </div>
    <div class="controls">
      <button type="button" id="bridgeOpen">🌉 Bridge</button>
      <a class="pill" href="#help">Help</a>
    </div>
  </header>

  <!-- Intro / Bridge info -->
  <section class="card">
    <div class="titleline"><h3>Intro — how this works with Jar</h3><div class="huebar" aria-hidden="true"></div></div>
    <p><b>Sine</b> is a tool—for sound and breath. <b>Jar</b> is the home for reflection and story: <b>School</b> (guides), <b>Rooms</b> (prompts/rituals), and <b>Egg</b> (origin). Use <b>Honey</b> here as your warm 128 Hz bed; <b>MirrorHoney</b> adds a headphone‑friendly mirror sway. When you’re ready to write or explore story, tap <span class="kbd">Bridge</span> → <b>Jar · School</b> or <b>Rooms</b>. Your audio stops as we cross; nothing is saved to a server.</p>
  </section>

  <!-- Scenes + Moon -->
  <section class="card" id="scenesMoon">
    <div class="titleline"><h3>Scenes &amp; Moon rhythm</h3><div class="huebar" aria-hidden="true"></div></div>
    <div class="controls">
      <label>Scene
        <select id="scene">
          <option value="custom">— Choose a Scene —</option>
          <option>Hayley</option>
          <option>Swift</option>
          <option>Marina</option>
          <option>Sabrina</option>
          <option>Ariana + Dua</option>
          <option>Doechii</option>
        </select>
      </label>
      <span class="pill badgelike">Moon <span id="moonEmoji" class="moon">🌗</span> <b id="moonName">Waning</b></span>
      <label>Rhythm
        <select id="moonMode">
          <option value="auto">Auto (Moon today)</option>
          <option value="new">New · 4–4–4</option>
          <option value="waxing">Waxing · 4–5–6</option>
          <option value="full">Full · 4–7–8</option>
          <option value="waning">Waning · 4–6–6</option>
          <option value="custom">Custom (use controls)</option>
        </select>
      </label>
      <span class="note">Scenes set Single Tone / Binaural defaults; adjust anytime. Moon sets Breath Pacer (and the 1‑min breath on Resonance).</span>
    </div>
  </section>

  <!-- Honey + MirrorHoney -->
  <section class="card" id="honey">
    <div class="titleline"><h3>🍯 Honey &amp; 🪞 MirrorHoney</h3><div class="huebar" aria-hidden="true"></div></div>
    <div class="controls">
      <button id="hn-start" type="button">Start Honey (128 Hz)</button>
      <button id="hn-stop" type="button">Stop</button>
      <label>Volume <input id="hn-vol" type="range" min="0" max="100" value="24"></label>
      <label class="badgelike"><input id="hn-mirror" type="checkbox"> MirrorHoney (stereo)</label>
      <span class="pill">Best on headphones.</span>
    </div>
    <p class="note">MirrorHoney uses stereo pan &amp; a gentle micro‑beat for a soft “mirror” sway. On speakers it may partially cancel; headphones recommended.</p>
  </section>

  <!-- Breath Pacer (Moon-aware) -->
  <section class="card" id="pacer">
    <div class="titleline"><h3>Breath Pacer</h3><div class="huebar" aria-hidden="true"></div></div>
    <div class="row">
      <div class="controls">
        <label>In (s) <input id="bp-in" type="number" min="1" max="20" value="4"></label>
        <label>Out (s) <input id="bp-out" type="number" min="1" max="30" value="6"></label>
        <span class="pill" id="bp-state">IDLE</span>
        <button type="button" id="bp-start">Start</button>
        <button type="button" id="bp-stop">Stop</button>
      </div>
      <div class="note">Moon <span id="moonEmoji2" class="moon">🌗</span> sets these automatically if Rhythm is <b>Auto</b> above.</div>
    </div>
  </section>

  <!-- Single Tone (with Flytrap) -->
  <section class="card" id="tone">
    <div class="titleline"><h3>Single Tone</h3><div class="huebar" aria-hidden="true"></div></div>
    <div class="row">
      <div class="controls">
        <label>Hz <input id="st-f" type="number" min="20" max="2000" step="0.1" value="136.1"></label>
        <input id="st-f-range" type="range" min="20" max="2000" step="0.1" value="136.1" aria-label="Frequency slider">
        <label>Vol <input id="st-v" type="range" min="0" max="100" value="22"></label>
        <label>Wave
          <select id="st-wave"><option>sine</option><option>triangle</option><option>sawtooth</option><option>square</option></select>
        </label>
        <div class="meter"><i id="st-viz"></i></div>
        <button type="button" id="st-start">Start</button>
        <button type="button" id="st-stop">Stop</button>
        <label class="badgelike"><input id="st-flytrap" type="checkbox"> 🪴 Venus Flytrap (gentle gate)</label>
      </div>
      <div class="note">Tip: 128–150 Hz often feels chest‑centered; ~220 Hz is voice‑like. Flytrap will occasionally “close” the tone briefly—softly—encouraging ease.</div>
    </div>
  </section>

  <!-- Binaural -->
  <section class="card" id="binaural">
    <div class="titleline"><h3>Binaural</h3><div class="huebar" aria-hidden="true"></div></div>
    <div class="row">
      <div class="controls">
        <label>Base (Hz) <input id="bi-base" type="number" min="60" max="1000" step="0.1" value="220"></label>
        <label>Beat (Hz) <input id="bi-beat" type="number" min="1" max="20" step="0.1" value="8"></label>
        <label>Vol <input id="bi-v" type="range" min="0" max="100" value="18"></label>
        <div class="meter"><i id="bi-viz"></i></div>
        <button type="button" id="bi-start">Start</button>
        <button type="button" id="bi-stop">Stop</button>
      </div>
      <div class="note"><b>Headphones only.</b> Left plays base; right plays base+beat to create the perceived rhythm.</div>
    </div>
  </section>

  <!-- Calming Sequence -->
  <section class="card" id="sequence">
    <div class="titleline"><h3>Calming Sequence</h3><div class="huebar" aria-hidden="true"></div></div>
    <div class="row">
      <div class="controls">
        <label>P1 Hz <input id="cs-f1" type="number" min="20" max="2000" step="0.1" value="150"></label>
        <label>sec <input id="cs-t1" type="number" min="1" max="600" step="1" value="20"></label>
        <label>P2 Hz <input id="cs-f2" type="number" min="20" max="2000" step="0.1" value="180"></label>
        <label>sec <input id="cs-t2" type="number" min="1" max="600" step="1" value="20"></label>
        <label>P3 Hz <input id="cs-f3" type="number" min="20" max="2000" step="0.1" value="136.1"></label>
        <label>sec <input id="cs-t3" type="number" min="1" max="600" step="1" value="40"></label>
        <span class="pill" id="cs-state">IDLE</span>
        <button type="button" id="cs-start">Start</button>
        <button type="button" id="cs-stop">Stop</button>
      </div>
      <div class="note">Three phases of “frequency • seconds.” Adjust to taste, or select a Scene to prefill.</div>
    </div>
  </section>

  <!-- Help / FAQs -->
  <section class="card faq" id="help">
    <div class="titleline"><h3>Notes · FAQs</h3><div class="huebar" aria-hidden="true"></div></div>
    <details><summary>How do I pair Sine with Jar?</summary><p>Use sound/breath here. When you feel a phrase or story arrive, tap <b>Bridge</b> → <b>Jar · School</b> (guides) or <b>Rooms</b> (prompts). Audio stops as we cross. Nothing is uploaded.</p></details>
    <details><summary>What is MirrorHoney?</summary><p>A stereo honey bed (128 Hz) with gentle mirror pan/micro‑beat; best on headphones.</p></details>
    <details><summary>Venus Flytrap?</summary><p>A playful soft gate: <b>Sine</b> closes briefly at calm intervals; <b>Resonance</b> closes when your hum wobbles (Mic Glow steadiness dips), then re‑opens as you settle.</p></details>
    <details><summary>Where else is Help?</summary><p>Here, or the Support · FAQs on <b>Froot</b> (same voice, same ground rules: local‑only, gentle volume). </p></details>
  </section>

  <footer class="note">Be kind to your ears. If in doubt, lower the volume and rest.</footer>
</div>

<!-- Bridge modal -->
<div id="bridgeModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,12,16,.55);backdrop-filter:blur(6px);z-index:9999">
  <div style="width:min(520px,92vw);border:1px solid rgba(255,255,255,.16);border-radius:16px;padding:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.08))">
    <h3 style="margin:0 0 6px">Liminal Bridge</h3>
    <p style="color:#a8b3c7;margin:6px 0 12px">Two lights, one path: practice here; reflect in Jar. Choose where to land:</p>
    <div class="controls">
      <button type="button" id="toSchool">↩ Jar · School</button>
      <button type="button" id="toRooms">↩ Jar · Rooms</button>
      <button type="button" id="toEgg">↩ Egg Map</button>
      <button type="button" id="bridgeClose" style="margin-left:auto">Stay here</button>
    </div>
    <p class="note" style="margin-top:10px">“Jar · Tunes” is where Honey/MirrorHoney lives in story form; for now we carry the sound with us.</p>
  </div>
</div>

<script>
/* ---------- Bridge host helper ---------- */
function jarBaseURL(){
  var h=location.hostname;
  if(h==='localhost'||h==='127.0.0.1') return '';
  var p=h.split('.'); if(p.length>=2){ p[0]='jar'; return location.protocol+'//'+p.join('.'); }
  return '';
}
const bridgeModal=document.getElementById('bridgeModal');
document.getElementById('bridgeOpen').onclick=()=>{ try{ stopAll(); }catch(_){ } bridgeModal.style.display='flex'; };
document.getElementById('bridgeClose').onclick=()=>bridgeModal.style.display='none';
document.getElementById('toSchool').onclick=()=>location.assign((jarBaseURL()||'')+'/school.html');
document.getElementById('toRooms').onclick=()=>location.assign((jarBaseURL()||'')+'/school-rooms.html');
document.getElementById('toEgg').onclick=()=>location.assign((jarBaseURL()||'')+'/marina-egg.html');

/* ---------- Audio context ---------- */
let ctx, master, comp;
function ensureCtx(){
  if(!ctx){
    ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:"interactive"});
    master=ctx.createGain(); master.gain.value=.85;
    comp=ctx.createDynamicsCompressor();
    comp.threshold.value=-18; comp.knee.value=12; comp.ratio.value=2; comp.attack.value=.01; comp.release.value=.3;
    master.connect(comp); comp.connect(ctx.destination);
    document.addEventListener('click', ()=>ctx.resume(), {once:true});
  }
}
function ramp(param, val, t=.15){ const now=ctx.currentTime; param.cancelScheduledValues(now); param.setValueAtTime(param.value, now); param.linearRampToValueAtTime(val, now+t); }
function stopAll(){ try{stStop();}catch(_){ } try{stopBinaural();}catch(_){ } try{hnStop();}catch(_){ } try{csStopSeq();}catch(_){ } }

/* ---------- Moon phase ---------- */
function moonPhaseInfo(d=new Date()){
  // Simple approximation (not astronomy-grade)
  const lp=2551443; // synodic month (s) ~29.53d
  const new_moon=new Date(Date.UTC(2000,0,6,18,14)); // ref
  const phase=((d - new_moon)/1000)%lp; const age=phase/(24*3600);
  const frac=age/29.530588; const f=(frac+1)%1;
  let name='Waxing', emoji='🌔';
  if(f<0.03||f>0.97){ name='New'; emoji='🌑'; }
  else if(f<0.21){ name='Waxing'; emoji='🌒'; }
  else if(f<0.29){ name='First Quarter'; emoji='🌓'; }
  else if(f<0.46){ name='Waxing'; emoji='🌔'; }
  else if(f<0.54){ name='Full'; emoji='🌕'; }
  else if(f<0.71){ name='Waning'; emoji='🌖'; }
  else if(f<0.79){ name='Last Quarter'; emoji='🌗'; }
  else { name='Waning'; emoji='🌘'; }
  return {name, emoji};
}
function applyMoonToBreath(){
  const mode=document.getElementById('moonMode').value;
  const info=moonPhaseInfo();
  document.getElementById('moonEmoji').textContent=info.emoji;
  document.getElementById('moonEmoji2').textContent=info.emoji;
  document.getElementById('moonName').textContent=info.name;
  if(mode==='custom') return;
  let inS=4,outS=6;
  const m = mode==='auto' ? info.name.toLowerCase() :
            mode==='new' ? 'new' :
            mode==='waxing' ? 'waxing' :
            mode==='full' ? 'full' :
            'waning';
  if(m==='new'){ inS=4; outS=4; }
  else if(m==='waxing'){ inS=4; outS=6; } // 4–5–6 simplified to 4–6 here (pacer has IN/OUT)
  else if(m==='full'){ inS=4; outS=8; }
  else if(m==='waning'){ inS=4; outS=6; }
  document.getElementById('bp-in').value=inS;
  document.getElementById('bp-out').value=outS;
}
document.getElementById('moonMode').onchange=applyMoonToBreath;
applyMoonToBreath();

/* ---------- Honey / MirrorHoney ---------- */
let hnOscL=null, hnOscR=null, hnGainL=null, hnGainR=null, hnPan=null, hnBeat=null;
const hnVol=document.getElementById('hn-vol'), hnMirror=document.getElementById('hn-mirror');
function hnStart(){
  ensureCtx(); if(hnOscL) return;
  const now=ctx.currentTime;
  hnOscL=ctx.createOscillator(); hnOscR=ctx.createOscillator();
  hnGainL=ctx.createGain(); hnGainR=ctx.createGain();
  hnOscL.type='sine'; hnOscR.type='sine';
  hnOscL.frequency.value=128.0; hnOscR.frequency.value=128.0;
  hnGainL.gain.value=0.0; hnGainR.gain.value=0.0;
  // Stereo
  const merger=ctx.createChannelMerger(2);
  hnOscL.connect(hnGainL); hnGainL.connect(merger,0,0);
  hnOscR.connect(hnGainR); hnGainR.connect(merger,0,1);
  merger.connect(master);
  hnOscL.start(now); hnOscR.start(now);
  // Mirror pan / micro-beat
  if(hnMirror.checked){
    hnBeat=ctx.createOscillator(); hnBeat.frequency.value=0.25; // very slow
    const gL=ctx.createGain(), gR=ctx.createGain();
    gL.gain.value=0.03; gR.gain.value=0.03;
    hnBeat.connect(gL); hnBeat.connect(gR);
    gL.connect(hnGainL.gain); gR.connect(hnGainR.gain);
    hnBeat.start(now);
  }
  ramp(hnGainL.gain,(Number(hnVol.value)||0)/100*0.30,.22);
  ramp(hnGainR.gain,(Number(hnVol.value)||0)/100*0.30,.22);
}
function hnStop(){
  if(!hnOscL) return; const now=ctx.currentTime;
  ramp(hnGainL.gain,0.0005,.18); ramp(hnGainR.gain,0.0005,.18);
  setTimeout(()=>{try{hnOscL.stop();hnOscR.stop();}catch(_){ }
    hnOscL.disconnect();hnOscR.disconnect();hnGainL.disconnect();hnGainR.disconnect();
    if(hnBeat){ try{hnBeat.stop()}catch(_){ } hnBeat.disconnect(); hnBeat=null; }
    hnOscL=hnOscR=hnGainL=hnGainR=null;
  },200);
}
hnVol.oninput=()=>{ if(hnGainL) ramp(hnGainL.gain,(Number(hnVol.value)||0)/100*0.30,.06); if(hnGainR) ramp(hnGainR.gain,(Number(hnVol.value)||0)/100*0.30,.06); };
hnMirror.onchange=()=>{ if(hnOscL){ hnStop(); setTimeout(hnStart,220); } };
document.getElementById('hn-start').onclick=hnStart;
document.getElementById('hn-stop').onclick=hnStop;

/* ---------- Breath Pacer ---------- */
const bpIn=document.getElementById('bp-in'), bpOut=document.getElementById('bp-out'), bpState=document.getElementById('bp-state');
let bpTid=0, bpOn=false;
function bpFlash(){ bpState.style.boxShadow='0 0 0 8px rgba(164,255,101,.25)'; setTimeout(()=>bpState.style.boxShadow='none',160); }
function bpClick(){ if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0; o.connect(g); g.connect(master); const now=ctx.currentTime; g.gain.linearRampToValueAtTime(0.018, now+.01); g.gain.linearRampToValueAtTime(0.0, now+.12); o.start(now); o.stop(now+.14); }
function runPacer(){
  if(!bpOn) return;
  bpState.textContent='IN'; bpFlash(); bpClick();
  const t1=(parseInt(bpIn.value,10)||4)*1000;
  clearTimeout(bpTid); bpTid=setTimeout(()=>{
    if(!bpOn) return;
    bpState.textContent='OUT'; bpFlash(); bpClick();
    const t2=(parseInt(bpOut.value,10)||6)*1000;
    bpTid=setTimeout(()=>runPacer(), t2);
  }, t1);
}
document.getElementById('bp-start').onclick=()=>{ ensureCtx(); bpOn=true; runPacer(); };
document.getElementById('bp-stop').onclick =()=>{ bpOn=false; bpState.textContent='IDLE'; clearTimeout(bpTid); };

/* ---------- Single Tone + Flytrap ---------- */
const stF=document.getElementById('st-f'), stR=document.getElementById('st-f-range'), stV=document.getElementById('st-v'), stWave=document.getElementById('st-wave'), stViz=document.getElementById('st-viz'), stTrap=document.getElementById('st-flytrap');
let stOsc=null, stGain=null, stRAF=0, trapId=0;
function stMeter(){ if(!stGain){ stViz.style.width='0%'; return; } const v=stGain.gain.value; stViz.style.width=Math.min(100, Math.max(0, v*400))+'%'; stRAF=requestAnimationFrame(stMeter); }
function stSync(val){ stF.value=val; stR.value=val; if(stOsc) ramp(stOsc.frequency, Math.max(20, Math.min(20000, Number(val)||136.1)), .12); }
stF.oninput=e=>stSync(e.target.value); stR.oninput=e=>stSync(e.target.value);
stV.oninput=e=>{ if(stGain) ramp(stGain.gain, (Number(e.target.value)||0)/100*0.30, .05); };
stWave.onchange=()=>{ if(stOsc) try{ stOsc.type=stWave.value; }catch(_){ } };
function stStart(){
  ensureCtx(); if(stOsc) return;
  stOsc=ctx.createOscillator(); stGain=ctx.createGain();
  stOsc.type=stWave.value; stOsc.frequency.value=Number(stF.value)||136.1;
  stGain.gain.value=0.0; stOsc.connect(stGain); stGain.connect(master);
  stOsc.start(); ramp(stGain.gain,(Number(stV.value)||0)/100*0.30,.18); stMeter();
  if(stTrap.checked){ startFlytrap(); }
}
function stStop(){
  if(!stOsc) return;
  ramp(stGain.gain,0.0005,.15);
  setTimeout(()=>{ try{stOsc.stop()}catch(_){ } stOsc.disconnect(); stGain.disconnect(); stOsc=null; stGain=null; cancelAnimationFrame(stRAF); stopFlytrap(); }, 180);
}
document.getElementById('st-start').onclick=stStart;
document.getElementById('st-stop').onclick =stStop;
stTrap.onchange=()=>{ if(stTrap.checked) startFlytrap(); else stopFlytrap(); };
function startFlytrap(){
  stopFlytrap();
  trapId=setInterval(()=>{
    if(!stGain) return;
    // gentle “close” for ~160ms then reopen
    const now=ctx.currentTime;
    stGain.gain.cancelScheduledValues(now);
    const base=(Number(stV.value)||0)/100*0.30;
    stGain.gain.setValueAtTime(stGain.gain.value, now);
    stGain.gain.linearRampToValueAtTime(base*0.35, now+0.08);
    stGain.gain.linearRampToValueAtTime(base, now+0.22);
  }, 3200 + Math.random()*2400);
}
function stopFlytrap(){ if(trapId){ clearInterval(trapId); trapId=0; } }

/* ---------- Binaural ---------- */
const biBase=document.getElementById('bi-base'), biBeat=document.getElementById('bi-beat'), biV=document.getElementById('bi-v'), biViz=document.getElementById('bi-viz');
let biL=null, biR=null, biGL=null, biGR=null, merger=null, biRAF=0;
function biMeter(){ if(!biGL){ biViz.style.width='0%'; return; } biViz.style.width=(biGL.gain.value*400)+'%'; biRAF=requestAnimationFrame(biMeter); }
function startBinaural(){
  ensureCtx(); if(biL) return;
  biL=ctx.createOscillator(); biR=ctx.createOscillator(); biGL=ctx.createGain(); biGR=ctx.createGain(); merger=ctx.createChannelMerger(2);
  const base=Number(biBase.value)||220, beat=Number(biBeat.value)||8;
  biL.type='sine'; biR.type='sine'; biL.frequency.value=base; biR.frequency.value=base+beat;
  biGL.gain.value=0; biGR.gain.value=0;
  biL.connect(biGL); biR.connect(biGR); biGL.connect(merger,0,0); biGR.connect(merger,0,1); merger.connect(master);
  biL.start(); biR.start();
  ramp(biGL.gain,(Number(biV.value)||0)/100*0.30,.18); ramp(biGR.gain,(Number(biV.value)||0)/100*0.30,.18);
  biMeter();
}
function stopBinaural(){
  if(!biL) return;
  ramp(biGL.gain,0.0005,.15); ramp(biGR.gain,0.0005,.15);
  setTimeout(()=>{ try{biL.stop();biR.stop();}catch(_){ } biL.disconnect(); biR.disconnect(); biGL.disconnect(); biGR.disconnect(); merger.disconnect();
    biL=biR=biGL=biGR=merger=null; cancelAnimationFrame(biRAF); }, 180);
}
document.getElementById('bi-start').onclick=startBinaural; document.getElementById('bi-stop').onclick=stopBinaural;
biBase.oninput=()=>{ if(biL) ramp(biL.frequency, Math.max(20,Number(biBase.value)||220), .12); if(biR) ramp(biR.frequency, Math.max(21,(Number(biBase.value)||220)+(Number(biBeat.value)||8)), .12); };
biBeat.oninput=()=>{ if(biR) ramp(biR.frequency, Math.max(21,(Number(biBase.value)||220)+(Number(biBeat.value)||8)), .12); };
biV.oninput=()=>{ if(biGL) ramp(biGL.gain,(Number(biV.value)||0)/100*0.30,.05); if(biGR) ramp(biGR.gain,(Number(biV.value)||0)/100*0.30,.05); };

/* ---------- Calming Sequence ---------- */
const cs={ f:[document.getElementById('cs-f1'),document.getElementById('cs-f2'),document.getElementById('cs-f3')],
           t:[document.getElementById('cs-t1'),document.getElementById('cs-t2'),document.getElementById('cs-t3')],
           state:document.getElementById('cs-state') };
let csOsc=null, csGain=null, csIdx=-1, csStop=false;
function csStep(){
  if(csStop) return;
  csIdx++; if(csIdx>2){ csStopSeq(); return; }
  const hz=Number(cs.f[csIdx].value)||150, sec=Math.max(1,Number(cs.t[csIdx].value)||20);
  cs.state.textContent='PHASE '+(csIdx+1);
  if(!csOsc){ ensureCtx(); csOsc=ctx.createOscillator(); csGain=ctx.createGain(); csOsc.type='sine'; csOsc.frequency.value=hz; csGain.gain.value=0; csOsc.connect(csGain); csGain.connect(master); csOsc.start(); ramp(csGain.gain,0.18,.18);}
  else{ ramp(csOsc.frequency, hz, .20); }
  setTimeout(csStep, sec*1000);
}
function csStart(){ csStop=false; csIdx=-1; csStep(); }
function csStopSeq(){
  csStop=true; cs.state.textContent='IDLE';
  if(!csOsc) return; ramp(csGain.gain,0.0005,.18); setTimeout(()=>{ try{csOsc.stop()}catch(_){ } csOsc.disconnect(); csGain.disconnect(); csOsc=null; csGain=null; },220);
}
document.getElementById('cs-start').onclick=csStart; document.getElementById('cs-stop').onclick=csStopSeq;

/* ---------- Scenes (presets) ---------- */
const scenes={
  "Hayley":{ st:{f:220,w:"triangle",v:22}, bi:{base:220,beat:7,v:18}, seq:{f:[180,220,136.1],t:[20,20,40]}, pacer:{in:4,out:6} },
  "Swift": { st:{f:329.63,w:"sine",v:22}, bi:{base:330,beat:6,v:18}, seq:{f:[220,330,150],t:[16,16,40]}, pacer:{in:4,out:6} },
  "Marina":{ st:{f:349.23,w:"sine",v:20}, bi:{base:349.23,beat:8,v:18}, seq:{f:[150,349.23,220],t:[20,20,40]}, pacer:{in:4,out:6} },
  "Sabrina":{st:{f:554.37,w:"sine",v:18}, bi:{base:440,beat:8,v:16}, seq:{f:[220,440,136.1],t:[18,18,36]}, pacer:{in:4,out:6} },
  "Ariana + Dua":{st:{f:587.33,w:"sine",v:20}, bi:{base:587.33,beat:7,v:18}, seq:{f:[260,587.33,180],t:[18,18,40]}, pacer:{in:4,out:6} },
  "Doechii":{st:{f:150,w:"square",v:18}, bi:{base:150,beat:6,v:16}, seq:{f:[150,180,128],t:[20,20,40]}, pacer:{in:4,out:6} }
};
document.getElementById('scene').onchange=(e)=>{
  const v=e.target.value; if(!scenes[v]) return;
  const s=scenes[v];
  // Single tone
  stWave.value=s.st.w; stF.value=s.st.f; stR.value=s.st.f; stV.value=s.st.v;
  if(stOsc) ramp(stOsc.frequency, s.st.f, .12);
  if(stGain) ramp(stGain.gain, s.st.v/100*0.30, .12);
  // Binaural
  biBase.value=s.bi.base; biBeat.value=s.bi.beat; biV.value=s.bi.v;
  if(biL) ramp(biL.frequency, s.bi.base, .12);
  if(biR) ramp(biR.frequency, s.bi.base + s.bi.beat, .12);
  if(biGL) ramp(biGL.gain, s.bi.v/100*0.30, .12);
  if(biGR) ramp(biGR.gain, s.bi.v/100*0.30, .12);
  // Sequence
  ['f1','f2','f3'].forEach((id,i)=>document.getElementById('cs-'+id).value=s.seq.f[i]);
  ['t1','t2','t3'].forEach((id,i)=>document.getElementById('cs-'+id).value=s.seq.t[i]);
  // Pacer (respects Moon 'custom')
  if(document.getElementById('moonMode').value==='custom'){
    bpIn.value=s.pacer.in; bpOut.value=s.pacer.out;
  } else {
    applyMoonToBreath();
  }
};
</script>
</body>
</html>
